import{h as u,p as c}from"./chunk-KZEZHTV3.js";import{G as h,N as i,T as n,f as o,ta as a,z as p}from"./chunk-TMRUMUQV.js";var f=(()=>{let t=class t{constructor(){this.onTokenRefresh=new o}tokenRefreshed(){this.onTokenRefresh.next()}};t.\u0275fac=function(r){return new(r||t)},t.\u0275prov=i({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();var l={production:!1,apiUrl:"https://nodejs-production-e941.up.railway.app/api",socketUrl:"https://nodejs-production-e941.up.railway.app"};var U=(()=>{let t=class t{constructor(){this.url=l.apiUrl,this.http=n(u),this.router=n(c),this.refreshService=n(f),this.accessToken="",this.state=a({}),this.isLoggedIn=a(!1),this.user=a({}),this.userSubject=new o,this.getUser()}login(e){return this.http.post(this.url+"/auth/login",e).pipe(h())}refreshToken(){let e=this.user()?.accessToken;return console.log(e),this.http.post(this.url+"/auth/refresh",{accessToken:e}).pipe(p(1))}registration(e){return this.http.post(this.url+"/users/user",e).pipe(h())}logout(e){window.sessionStorage.removeItem("user"),this.state.update(r=>null),this.isLoggedIn.set(!1),e&&this.router.navigate([e])}setUser(e){window.sessionStorage.setItem("user",JSON.stringify(e)),this.user.update(()=>e),this.isLoggedIn.set(!0),this.userSubject.next(e)}getUser(){if(window.sessionStorage.getItem("user")==null)return;let e=JSON.parse(window.sessionStorage.getItem("user"));console.log(e),this.isTokenExpired()?this.refreshTokenIfExpired():(this.user.update(()=>e),this.isLoggedIn.set(!0),this.userSubject.next(e))}refreshTokenIfExpired(){this.isTokenExpired()&&this.refreshToken().subscribe({next:e=>{this.setUser(e),this.userSubject.next(e),this.refreshService.tokenRefreshed()},error:e=>{this.isLoggedIn.set(!1),this.logout("login")}})}isTokenExpired(){let e=this.user()?.accessToken;if(!e)return!1;let r=JSON.parse(window.atob(e.split(".")[1])),d=Math.floor(Date.now()/1e3);return!(r.exp-d>10)}};t.\u0275fac=function(r){return new(r||t)},t.\u0275prov=i({token:t,factory:t.\u0275fac,providedIn:"root"});let s=t;return s})();export{f as a,U as b};
