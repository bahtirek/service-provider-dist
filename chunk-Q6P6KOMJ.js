import{h,p as c}from"./chunk-KZEZHTV3.js";import{G as i,N as p,T as n,f as a,ta as r,z as u}from"./chunk-TMRUMUQV.js";var l={production:!1,apiUrl:"https://nodejs-production-e941.up.railway.app/api",socketUrl:"https://nodejs-production-e941.up.railway.app"};var x=(()=>{let t=class t{constructor(){this.url=l.apiUrl,this.http=n(h),this.router=n(c),this.accessToken="",this.state=r({}),this.isLoggedIn=r(!1),this.user=r({}),this.userSubject=new a,this.getUser()}login(e){return this.http.post(this.url+"/auth/login",e).pipe(i())}refreshToken(){let e=this.user()?.accessToken;return console.log(e),this.http.post(this.url+"/auth/refresh",{accessToken:e}).pipe(u(1))}registration(e){return this.http.post(this.url+"/users/user",e).pipe(i())}logout(e){window.sessionStorage.removeItem("user"),window.localStorage.removeItem("provider"),window.localStorage.removeItem("client"),window.localStorage.removeItem("subject"),this.state.update(s=>null),this.isLoggedIn.set(!1),e&&this.router.navigate([e])}setUser(e){window.sessionStorage.setItem("user",JSON.stringify(e)),this.user.update(()=>e),this.isLoggedIn.set(!0),this.userSubject.next(e)}getUser(){if(window.sessionStorage.getItem("user")==null)return;let e=JSON.parse(window.sessionStorage.getItem("user"));console.log(e),this.isTokenExpired()?this.refreshTokenIfExpired():(this.user.update(()=>e),this.isLoggedIn.set(!0),this.userSubject.next(e))}refreshTokenIfExpired(){this.isTokenExpired()&&this.refreshToken().subscribe({next:e=>{this.setUser(e),this.userSubject.next(e)},error:e=>{this.isLoggedIn.set(!1),this.logout("login")}})}isTokenExpired(){let e=this.user()?.accessToken;if(!e)return!1;let s=JSON.parse(window.atob(e.split(".")[1])),f=Math.floor(Date.now()/1e3);return!(s.exp-f>10)}};t.\u0275fac=function(s){return new(s||t)},t.\u0275prov=p({token:t,factory:t.\u0275fac,providedIn:"root"});let o=t;return o})();export{x as a};
